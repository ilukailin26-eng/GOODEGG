from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor
import logging

# ===========================
API_TOKEN = "8540526586:AAFkeCCu3FoMcpZq_4hc8iVhx_xNbdOh27M"
CHANNEL_ID = "@PodslushanoScoolKrg"  # —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª
ADMIN_ID = 7335111629  # —Ç–≤–æ–π Telegram ID
# ===========================

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# --- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---
type_keyboard = InlineKeyboardMarkup(row_width=2)
type_keyboard.add(
    InlineKeyboardButton("üï∂ –ê–Ω–æ–Ω–∏–º–Ω–æ–µ", callback_data="anonymous"),
    InlineKeyboardButton("üë§ –û—Ç–∫—Ä—ã—Ç–æ–µ", callback_data="open")
)

# --- –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ ---
moderate_keyboard = InlineKeyboardMarkup(row_width=3)
moderate_keyboard.add(
    InlineKeyboardButton("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="send"),
    InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data="reject"),
    InlineKeyboardButton("üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å", callback_data="reply")
)

# --- –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π ---
user_data = {}  # key=user_id, value=dict(type, school, text, admin_msg_id)

# --- /start ---
@dp.message_handler(commands=['start'])
async def start_cmd(message: types.Message):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª —Å—Ä–∞–∑—É, –Ω–∞–∂–º–∏—Ç–µ /start –µ—â—ë —Ä–∞–∑.\n–ö–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?",
        reply_markup=type_keyboard
    )

# --- –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---
@dp.callback_query_handler(lambda c: c.data in ["anonymous", "open"])
async def choose_type(callback_query: types.CallbackQuery):
    user_data[callback_query.from_user.id] = {"type": callback_query.data}
    await bot.send_message(callback_query.from_user.id, "–û—Ç –∫–∞–∫–æ–π —à–∫–æ–ª—ã –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å?")
    await callback_query.answer()

# --- –ü–æ–ª—É—á–µ–Ω–∏–µ —à–∫–æ–ª—ã ---
@dp.message_handler(lambda m: m.from_user.id in user_data and "school" not in user_data[m.from_user.id])
async def get_school(message: types.Message):
    user_data[message.from_user.id]["school"] = message.text
    await message.answer("–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:")

# --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---
@dp.message_handler(lambda m: m.from_user.id in user_data and "text" not in user_data[m.from_user.id])
async def get_text(message: types.Message):
    t = user_data[message.from_user.id]
    t["text"] = message.text

    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
    msg = f"{'üï∂ –ê–ù–û–ù–ò–ú–ù–û–ï' if t['type']=='anonymous' else 'üë§ –û–¢–ö–†–´–¢–û–ï'} –°–û–û–ë–©–ï–ù–ò–ï\n–®–∫–æ–ª–∞: {t['school']}\n\n{t['text']}"
    
    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
    admin_msg = await bot.send_message(ADMIN_ID, msg, reply_markup=moderate_keyboard)
    t["admin_msg_id"] = admin_msg.message_id

    await message.answer("‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –Ω–∞–∂–º–∏—Ç–µ /start –µ—â—ë —Ä–∞–∑.")

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ ---
@dp.callback_query_handler(lambda c: c.data in ["send", "reject", "reply"])
async def moderation_buttons(callback_query: types.CallbackQuery):
    t = None
    # –Ω–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é
    for user_id, data in user_data.items():
        if data.get("admin_msg_id") == callback_query.message.message_id:
            t = data
            break

    if t is None:
        await callback_query.answer("–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        return

    user_id = user_id  # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    msg_text = f"üï∂ –ê–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n–®–∫–æ–ª–∞ ‚Äì {t['school']}\n\n{t['text']}" if t['type']=='anonymous' else f"üë§ –û—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç @{callback_query.from_user.username}\n–®–∫–æ–ª–∞ ‚Äì {t['school']}\n\n{t['text']}"

    if callback_query.data == "send":
        await bot.send_message(CHANNEL_ID, msg_text)
        await bot.send_message(user_id, "‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª.")
        await callback_query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª")
    elif callback_query.data == "reject":
await bot.send_message(user_id, "‚ùå –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
        await callback_query.answer("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ")
    elif callback_query.data == "reply":
        await bot.send_message(user_id, "‚úâÔ∏è –û—Ç–≤–µ—Ç –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:\n–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:")
        await callback_query.answer("–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")

if name == 'main':
    executor.start_polling(dp, skip_updates=True)